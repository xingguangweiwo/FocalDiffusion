<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 760" role="img" aria-labelledby="title desc">
  <title id="title">FocalDiffusion training + inference schematic</title>
  <desc id="desc">Clean publication-style diagram showing focal stacks, camera priors, simulated augmentation, diffusion backbone, and separate training/inference flows with explicit loss targets.</desc>
  <defs>
    <linearGradient id="bg" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#f8fafc" />
      <stop offset="100%" stop-color="#e2e8f0" />
    </linearGradient>
    <linearGradient id="model" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#dbeafe" />
      <stop offset="100%" stop-color="#e0f2fe" />
    </linearGradient>
    <linearGradient id="cond" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#dcfce7" />
      <stop offset="100%" stop-color="#bbf7d0" />
    </linearGradient>
    <linearGradient id="loss" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#ffe4e6" />
      <stop offset="100%" stop-color="#fecdd3" />
    </linearGradient>
    <linearGradient id="out" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#fff7ed" />
      <stop offset="100%" stop-color="#ffedd5" />
    </linearGradient>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="12" markerHeight="12" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0f172a" />
    </marker>
    <marker id="arrowLoss" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="12" markerHeight="12" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#b91c1c" />
    </marker>
    <marker id="arrowInfer" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="12" markerHeight="12" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0ea5e9" />
    </marker>
    <style>
      text { font-family: 'Helvetica Neue', Arial, sans-serif; fill: #0f172a; }
      .title { font-size: 24px; font-weight: 800; letter-spacing: 0.3px; }
      .subtitle { font-size: 15px; fill: #475569; }
      .panel { fill: url(#bg); stroke: #cbd5e1; stroke-width: 2; rx: 16; ry: 16; }
      .card { fill: #ffffff; stroke: #94a3b8; stroke-width: 1.6; rx: 12; ry: 12; filter: drop-shadow(0px 2px 6px rgba(0,0,0,0.06)); }
      .card-soft { fill: url(#cond); stroke: #34d399; stroke-width: 1.6; rx: 12; ry: 12; filter: drop-shadow(0px 2px 6px rgba(0,0,0,0.06)); }
      .card-model { fill: url(#model); stroke: #60a5fa; stroke-width: 1.8; rx: 12; ry: 12; filter: drop-shadow(0px 2px 6px rgba(0,0,0,0.07)); }
      .card-out { fill: url(#out); stroke: #f59e0b; stroke-width: 1.6; rx: 12; ry: 12; filter: drop-shadow(0px 2px 6px rgba(0,0,0,0.06)); }
      .card-loss { fill: url(#loss); stroke: #b91c1c; stroke-width: 1.6; rx: 12; ry: 12; filter: drop-shadow(0px 2px 6px rgba(0,0,0,0.06)); }
      .card-title { font-size: 16px; font-weight: 700; }
      .small { font-size: 13px; fill: #475569; }
      .label { font-size: 12px; font-weight: 700; fill: #0f172a; letter-spacing: 0.3px; }
      .arrow { stroke: #0f172a; stroke-width: 2.6; marker-end: url(#arrow); fill: none; }
      .arrow-infer { stroke: #0ea5e9; stroke-width: 2.6; marker-end: url(#arrowInfer); fill: none; stroke-dasharray: 7 6; }
      .arrow-loss { stroke: #b91c1c; stroke-width: 2.6; marker-end: url(#arrowLoss); fill: none; }
      .badge { font-size: 13px; font-weight: 800; fill: #0f172a; text-transform: uppercase; letter-spacing: 0.4px; }
    </style>
  </defs>

  <!-- Canvas framing -->
  <rect x="18" y="18" width="1364" height="724" fill="white" stroke="#cbd5e1" stroke-width="2" rx="18" ry="18" />
  <rect x="36" y="40" width="1328" height="684" class="panel" />

  <!-- Header -->
  <text x="56" y="86" class="title">FocalDiffusion â€” all-in-focus RGB + metric depth from focal stacks</text>
  <text x="56" y="112" class="subtitle">Camera-aware diffusion with focal fusion, simulated stacks, and dual-head SD3.5 supervision</text>

  <!-- Section labels -->
  <text x="76" y="152" class="badge">A. Inputs & augmentation</text>
  <text x="520" y="152" class="badge">B. Focal-aware diffusion backbone</text>
  <text x="1030" y="152" class="badge">C. Outputs, losses, inference</text>

  <!-- Column frames -->
  <rect x="60" y="168" width="360" height="540" class="card" opacity="0.85" />
  <rect x="500" y="168" width="360" height="540" class="card" opacity="0.85" />
  <rect x="940" y="168" width="360" height="540" class="card" opacity="0.85" />

  <!-- Inputs -->
  <rect x="86" y="194" width="308" height="130" class="card-soft" />
  <text x="106" y="224" class="card-title">Focal stack (N slices)</text>
  <text x="106" y="248" class="small">Variable focus distances, apertures, exposure</text>
  <text x="106" y="269" class="small">Optional all-in-focus RGB as teacher</text>
  <text x="106" y="292" class="small">Per-slice tokens kept (no concatenation)</text>

  <rect x="86" y="346" width="308" height="110" class="card" />
  <text x="106" y="376" class="card-title">Camera priors</text>
  <text x="106" y="400" class="small">Intrinsics, plane-of-focus, CoC radius</text>
  <text x="106" y="421" class="small">Depth units & scale range</text>

  <rect x="86" y="486" width="308" height="110" class="card" />
  <text x="106" y="516" class="card-title">CoC simulator (augmentation)</text>
  <text x="106" y="540" class="small">Renders synthetic stacks from depth + intrinsics</text>
  <text x="106" y="561" class="small">Matches defocus distribution of real captures</text>

  <!-- Conditioning lane -->
  <rect x="520" y="194" width="320" height="110" class="card-soft" />
  <text x="540" y="224" class="card-title">Focal & camera conditioning</text>
  <text x="540" y="248" class="small">Focus plane embeddings, CoC radius, t-step</text>
  <text x="540" y="269" class="small">(optional) text / viewpoint tokens</text>

  <rect x="520" y="332" width="320" height="120" class="card-model" />
  <text x="540" y="362" class="card-title">Shared encoder</text>
  <text x="540" y="386" class="small">Per-slice visual tokens</text>
  <text x="540" y="407" class="small">Camera-aware positional priors</text>

  <rect x="520" y="476" width="320" height="120" class="card-model" />
  <text x="540" y="506" class="card-title">Focal fusion + SD3.5 U-Net</text>
  <text x="540" y="530" class="small">Cross-slice attention aligns defocus cues</text>
  <text x="540" y="551" class="small">Dual heads: all-in-focus RGB & metric depth</text>

  <!-- Outputs + inference -->
  <rect x="964" y="194" width="312" height="110" class="card-out" />
  <text x="984" y="224" class="card-title">All-in-focus RGB</text>
  <text x="984" y="248" class="small">Sharp reconstruction; preserves colour</text>

  <rect x="964" y="332" width="312" height="110" class="card-out" />
  <text x="984" y="362" class="card-title">Metric depth</text>
  <text x="984" y="386" class="small">Scale-consistent; defocus-aware</text>

  <rect x="964" y="470" width="312" height="120" class="card-loss" />
  <text x="984" y="500" class="card-title">Training losses</text>
  <text x="984" y="524" class="small">RGB: L1 + SSIM</text>
  <text x="984" y="545" class="small">Depth: L1 + scale clamp</text>
  <text x="984" y="566" class="small">Defocus consistency on fused tokens</text>

  <!-- Arrows: data flow -->
  <path d="M 394 259 C 430 259 460 259 520 259" class="arrow" />
  <path d="M 394 398 C 430 398 460 398 520 398" class="arrow" />
  <path d="M 394 544 C 430 544 460 520 520 520" class="arrow" />
  <path d="M 680 392 C 760 392 810 392 940 392" class="arrow" />
  <path d="M 680 544 C 760 544 810 544 940 544" class="arrow" />

  <!-- Arrows: training vs inference split -->
  <text x="700" y="620" class="label">Training</text>
  <path d="M 700 606 C 760 606 820 606 940 520" class="arrow" />
  <text x="700" y="664" class="label">Inference</text>
  <path d="M 700 650 C 820 650 1020 650 1160 420" class="arrow-infer" />

  <!-- Loss backprop targets -->
  <path d="M 1160 240 C 1200 240 1200 190 840 190" class="arrow-loss" />
  <path d="M 1160 380 C 1200 380 1200 190 840 190" class="arrow-loss" />
  <path d="M 1160 520 C 1200 520 1200 430 840 430" class="arrow-loss" />

  <!-- Slice thumbnails -->
  <rect x="120" y="238" width="58" height="58" fill="#0ea5e9" opacity="0.12" stroke="#0ea5e9" stroke-width="1.2" rx="8" ry="8" />
  <rect x="137" y="228" width="58" height="58" fill="#22c55e" opacity="0.12" stroke="#22c55e" stroke-width="1.2" rx="8" ry="8" />
  <rect x="154" y="218" width="58" height="58" fill="#f59e0b" opacity="0.12" stroke="#f59e0b" stroke-width="1.2" rx="8" ry="8" />
  <text x="214" y="250" class="label">N slices</text>

  <!-- Legend -->
  <rect x="1110" y="104" width="172" height="44" fill="#ffffff" stroke="#cbd5e1" stroke-width="1.2" rx="10" ry="10" />
  <rect x="1124" y="116" width="18" height="12" fill="url(#model)" stroke="#60a5fa" stroke-width="1.2" rx="3" ry="3" />
  <text x="1148" y="126" class="small">Backbone</text>
  <rect x="1200" y="116" width="18" height="12" fill="url(#cond)" stroke="#34d399" stroke-width="1.2" rx="3" ry="3" />
  <text x="1224" y="126" class="small">Condition</text>
  <rect x="1124" y="136" width="18" height="12" fill="url(#out)" stroke="#f59e0b" stroke-width="1.2" rx="3" ry="3" />
  <text x="1148" y="146" class="small">Outputs</text>
  <rect x="1200" y="136" width="18" height="12" fill="url(#loss)" stroke="#b91c1c" stroke-width="1.2" rx="3" ry="3" />
  <text x="1224" y="146" class="small">Loss</text>
</svg>
